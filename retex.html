<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Retour d'Expérience</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 2em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Oswald', sans-serif; font-weight: 500; text-align: center; }
        label { display: block; margin: 20px 0 5px 0; font-weight: bold; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; }
        textarea { min-height: 100px; }
        .action-buttons {
            display: flex; gap: 10px; margin-top: 20px;
        }
        .action-buttons button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
        }
        #submitButton { background-color: var(--accent-blue); color: white; }
        #submitButton:hover { background-color: var(--accent-hover); }
        #downloadButton { background-color: #27ae60; color: white; }
        #downloadButton:hover { background-color: #20954b; }

        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); transition: all 0.3s ease-in-out; }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 45px; height: 45px; font-size: 24px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; text-decoration: none; flex-shrink: 0; }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { width: 55px; height: 55px; padding: 5px; border-radius: 50%; border: none; background-color: transparent; }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { opacity: 0; width: 0; margin-left: -10px; visibility: hidden; }
        #dockToggleBtn .material-icons { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-icons { transform: rotate(180deg); }
        #statusMessage { margin-top: 20px; text-align: center; font-size: 1.1em; font-weight: bold; }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="Réduire"><span class="material-icons">expand_more</span></div>
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="Réinitialiser le formulaire"><span class="material-icons">refresh</span></div>
    </div>

    <div class="container">
        <h1>Formulaire de Retour d'Expérience (RETEX)</h1>
        <form id="retexForm">
            <input type="hidden" id="oiId" name="Identifiant_Unique_de_l_OI">

            <label for="date_op">Date de l'opération</label>
            <input type="date" id="date_op" name="Date_de_l_operation">

            <label for="type_op">Type d'opération</label>
            <select id="type_op" name="Type_d_operation">
                <option value="" disabled selected>Sélectionner un type</option>
                <option value="Forcené">Forcené</option>
                <option value="Domiciliaire">Domiciliaire</option>
                <option value="Milieu ouvert">Milieu ouvert</option>
                <option value="MO">MO</option>
                <option value="Autre">Autre</option>
            </select>
            
            <label for="role">Votre Rôle</label>
            <select id="role" name="Votre_Role">
                <option value="" disabled selected>Sélectionner un rôle</option>
                <option value="Commandement">Commandement</option>
                <option value="India">India</option>
                <option value="Effrac">Effrac</option>
                <option value="Appui Observation">Appui Observation</option>
                <option value="GD">GD</option>
                <option value="Tenue civile">Tenue civile</option>
                <option value="Cyno">Cyno</option>
                <option value="Enqueteur">Enquêteur</option>
            </select>

            <label for="q1">1. Les objectifs de la mission étaient-ils clairs et compris par tous ?</label>
            <textarea id="q1" name="Objectifs_Clairs"></textarea>

            <label for="q2">2. Quelle était la qualité et la précision du renseignement avant l'action ?</label>
            <textarea id="q2" name="Qualite_Renseignement"></textarea>

            <label for="q3">3. La planification tactique était-elle adaptée à la situation ?</label>
            <textarea id="q3" name="Planification_Tactique_Adaptee"></textarea>

            <label for="q4">4. Votre préparation individuelle était-elle suffisante ?</label>
            <textarea id="q4" name="Preparation_Individuelle_Suffisante"></textarea>

            <label for="q5">5. L'équipement individuel et collectif était-il adapté et fonctionnel ?</label>
            <textarea id="q5" name="Equipement_Adapte"></textarea>

            <label for="q6">6. Quels ont été les points forts de l'exécution de l'action ?</label>
            <textarea id="q6" name="Points_Forts_Execution"></textarea>

            <label for="q7">7. Quels ont été les points faibles de l'exécution de l'action ?</label>
            <textarea id="q7" name="Points_Faibles_Execution"></textarea>

            <label for="q8">8. Avez-vous rencontré des imprévus majeurs ? Comment l'équipe s'est-elle adaptée ?</label>
            <textarea id="q8" name="Imprevus_Majeurs"></textarea>

            <label for="q9">9. Évaluez l'efficacité de la communication interne à l'équipe.</label>
            <textarea id="q9" name="Communication_Interne"></textarea>

            <label for="q10">10. Évaluez l'efficacité de la communication externe (commandement, autres unités...).</label>
            <textarea id="q10" name="Communication_Externe"></textarea>

            <label for="q11">11. L'usage de la force ou des moyens d'interpellation a-t-il été pertinent et efficace ?</label>
            <textarea id="q11" name="Usage_Force_Pertinent"></textarea>

            <label for="q12">12. Comment la prise de décision tactique a-t-elle été gérée sur le terrain ?</label>
            <textarea id="q12" name="Prise_Decision_Tactique"></textarea>

            <label for="q13">13. La gestion des risques et de la sécurité du personnel a-t-elle été suffisante ?</label>
            <textarea id="q13" name="Gestion_Risques_Securite"></textarea>

            <label for="q14">14. Les objectifs initiaux de la mission ont-ils été atteints ?</label>
            <textarea id="q14" name="Objectifs_Atteints"></textarea>

            <label for="q15">15. Quel bilan matériel et humain dressez-vous ?</label>
            <textarea id="q15" name="Bilan_Materiel_Humain" placeholder="Blessures, équipement endommagé, perdu..."></textarea>

            <label for="q16">16. Quelles recommandations concrètes proposez-vous pour améliorer nos futures opérations ?</label>
            <textarea id="q16" name="Recommandations_Concretes" placeholder="Formation, équipement, procédures, doctrine..."></textarea>

            <div class="action-buttons">
                 <button type="button" id="downloadButton">Télécharger le fichier JSON</button>
            </div>
            
            <p id="statusMessage"></p>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script>
        const form = document.getElementById('retexForm');
        const statusMessage = document.getElementById('statusMessage');
        const downloadButton = document.getElementById('downloadButton');
        const oiIdField = document.getElementById('oiId');

        // --- GESTION DU THÈME ET DU DOCK MENU ---
        document.addEventListener('DOMContentLoaded', () => {
            // Thème
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                    document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
                });
            }
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.replace('dark-mode', 'light-mode');
                if (document.getElementById('darkModeIcon')) {
                    document.getElementById('darkModeIcon').textContent = 'clear_day';
                }
            }

            // Dock
            const dockMenu = document.getElementById('dockMenu');
            const dockToggleBtn = document.getElementById('dockToggleBtn');
            if (dockToggleBtn) {
                dockToggleBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    dockMenu.classList.toggle('collapsed');
                    localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed'));
                });
            }
            if (localStorage.getItem('dockCollapsed') === 'true' && dockMenu) {
                dockMenu.classList.add('collapsed');
            }
            
            // Bouton Reset
            const resetBtn = document.getElementById('resetBtn');
            if(resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm("Voulez-vous vraiment réinitialiser le formulaire ?")) {
                        form.reset();
                        statusMessage.textContent = '';
                    }
                });
            }

            // Logique de chargement de l'oiId depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const oiId = urlParams.get('oiId');
            if (oiId) {
                oiIdField.value = oiId;
                statusMessage.textContent = "Identifiant d'opération détecté : " + oiId;
                statusMessage.style.color = 'var(--accent-blue)';
            } else {
                statusMessage.textContent = "ATTENTION : Aucun identifiant d'opération n'a été trouvé dans l'URL. Veuillez le renseigner manuellement si vous en avez un.";
                statusMessage.style.color = 'var(--danger-red)';
            }
        });

        // --- NOUVELLE FONCTIONNALITÉ : TÉLÉCHARGEMENT DU FICHIER JSON ---
        downloadButton.addEventListener('click', () => {
            const formData = {};
            const formElements = form.elements;
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name) {
                    formData[element.name] = element.value;
                }
            }

            // Nettoyage des champs vides
            for (const key in formData) {
                if (formData[key] === '' || formData[key] === null) {
                    delete formData[key];
                }
            }

            const jsonString = JSON.stringify(formData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            // Nom de fichier par défaut basé sur l'oiId ou la date
            const fileName = (oiIdField.value ? `Retex_${oiIdField.value}` : `Retex_${new Date().toISOString().slice(0, 10)}`) + '.json';
            a.download = fileName;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            statusMessage.textContent = `Fichier "${fileName}" généré et téléchargé avec succès !`;
            statusMessage.style.color = 'var(--success-green)';
        });
    </script>
</body>
</html>
