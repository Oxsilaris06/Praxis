<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse RETEX Experte</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --bg-body: #121212; 
            --bg-container: #1e1e1e; 
            --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; 
            --text-secondary: #95a5a6; 
            --border-color: #444444;
            --accent-blue: #5b9bd5; 
            --accent-hover: #4a7aa5; 
            --success-green: #27ae60;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Oswald', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            line-height: 1.6; 
            padding: 20px;
        }
        .container { 
            width: 100%; 
            max-width: 900px; 
            margin: auto; 
            background: var(--bg-container); 
            padding: 25px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }
        .toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 15px;
        }
        /* --- NOUVEAU : Style pour les labels du toggle --- */
        .toggle-container span {
            color: var(--text-secondary);
            transition: color 0.4s ease;
            font-weight: 400;
        }
        .toggle-container span.active {
            color: var(--text-primary);
            font-weight: 500;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-interactive);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--border-color);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-blue); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .mode-view { display: none; }
        .mode-view.active { display: block; animation: fadeIn 0.6s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h2 {
            color: var(--text-secondary);
            font-weight: 400;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        #drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #drop-zone.drag-over {
            background-color: var(--bg-interactive);
            border-color: var(--accent-blue);
        }
        #drop-zone p {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        #json-files-input { display: none; }
        #file-list-container {
            margin-top: 20px;
        }
        #file-list li {
            background-color: var(--bg-body);
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 5px;
            list-style-type: none;
            font-family: monospace;
        }

        textarea { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 20px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: 1.1rem; 
            background-color: var(--bg-interactive); 
            color: var(--text-primary); 
            font-family: 'Oswald', sans-serif;
            min-height: 250px; 
            resize: vertical;
        }

        button.btn-analyze {
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 22px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Oswald', sans-serif;
            font-size: 1.2em;
            background-color: var(--success-green);
            color: white;
            transition: background-color 0.3s;
        }
        button.btn-analyze:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #ai-status {
            text-align: center;
            padding: 15px;
            margin-top: 25px;
            background-color: var(--bg-body);
            border-radius: 5px;
            font-style: italic;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .output-area {
            background-color: var(--bg-body);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            min-height: 150px;
            white-space: pre-wrap;
            font-family: sans-serif;
            line-height: 1.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analyse RETEX Experte</h1>
            <div class="toggle-container">
                <span id="label-json">Analyse de Fichiers JSON</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="mode-toggle">
                    <span class="slider"></span>
                </label>
                <span id="label-text">Analyse de Texte Brut</span>
            </div>
        </div>

        <div id="json-mode" class="mode-view">
            <h2>√âtape 1 : Charger un ou plusieurs rapports .json</h2>
            <div id="drop-zone">
                <p>Glissez-d√©posez vos fichiers ici, ou cliquez pour s√©lectionner</p>
                <input type="file" id="json-files-input" multiple accept=".json">
            </div>
            <div id="file-list-container" style="display: none;">
                <ul id="file-list"></ul>
            </div>
            <button id="analyze-json-btn" class="btn-analyze" disabled>
                <span class="material-symbols-outlined">psychology</span> √âtape 2 : Lancer l'Analyse Experte
            </button>
        </div>
        
        <div id="text-mode" class="mode-view">
            <h2>√âtape 1 : Coller le rapport textuel</h2>
            <textarea id="ai-input" placeholder="Copiez-collez ici l'int√©gralit√© du compte-rendu..."></textarea>
            <button id="analyze-text-btn" class="btn-analyze" disabled>
                <span class="material-symbols-outlined">psychology</span> √âtape 2 : Lancer l'Analyse Experte
            </button>
        </div>
        
        <div id="ai-status">Initialisation du mod√®le expert... Veuillez patienter.</div>
        <div id="ai-output" class="output-area">
            Les r√©sultats de l'analyse appara√Ætront ici.
        </div>
    </div>
    
    <script type="module">
        import { CreateWebWorkerMLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/wasm/web-llm.js";

        // --- DOM Elements ---
        const modeToggle = document.getElementById('mode-toggle');
        const jsonModeView = document.getElementById('json-mode');
        const textModeView = document.getElementById('text-mode');
        const labelJson = document.getElementById('label-json');
        const labelText = document.getElementById('label-text');
        
        const aiStatus = document.getElementById('ai-status');
        const aiOutput = document.getElementById('ai-output');
        
        const dropZone = document.getElementById('drop-zone');
        const jsonFilesInput = document.getElementById('json-files-input');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const analyzeJsonBtn = document.getElementById('analyze-json-btn');

        const textInput = document.getElementById('ai-input');
        const analyzeTextBtn = document.getElementById('analyze-text-btn');

        let engine;

        // --- CORRIG√â : Logique du Toggle rendue plus robuste ---
        function updateViewMode() {
            const isTextMode = modeToggle.checked;

            // Met √† jour la vue principale
            jsonModeView.classList.toggle('active', !isTextMode);
            textModeView.classList.toggle('active', isTextMode);

            // Met √† jour le style des labels
            labelJson.classList.toggle('active', !isTextMode);
            labelText.classList.toggle('active', isTextMode);
        }

        modeToggle.addEventListener('change', updateViewMode);
        // Initialiser la vue au chargement de la page
        updateViewMode();
        // --- FIN DE LA CORRECTION ---

        // --- Drag & Drop and File Input Logic ---
        dropZone.addEventListener('click', () => jsonFilesInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            jsonFilesInput.files = e.dataTransfer.files;
            handleFiles(jsonFilesInput.files);
        });
        jsonFilesInput.addEventListener('change', () => handleFiles(jsonFilesInput.files));

        function handleFiles(files) {
            fileList.innerHTML = '';
            if (files.length > 0) {
                fileListContainer.style.display = 'block';
                Array.from(files).forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `üìÑ ${file.name}`;
                    fileList.appendChild(li);
                });
            } else {
                fileListContainer.style.display = 'none';
            }
        }

        // --- WebLLM Initialization ---
        const GGUF_MODEL_URL = "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-gguf/resolve/main/Phi-3-mini-4k-instruct-q4.gguf";
        const WASM_URL = "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/wasm/phi-3-mini-4k-instruct.wasm";
        const LOCAL_ID = "Phi-3-mini-4k-instruct-q4-gguf";

        const appConfig = {
            model_list: [{"model_url": GGUF_MODEL_URL, "local_id": LOCAL_ID, "model_lib_url": WASM_URL}]
        };

        const setProgress = (item) => {
            const progress = (item.progress * 100).toFixed(2);
            aiStatus.textContent = `${item.text} (${progress}%)`;
        };

        async function initializeWebLLM() {
            try {
                engine = await CreateWebWorkerMLCEngine(
                    new Worker(new URL('./web-llm-worker.js', import.meta.url), { type: 'module' }),
                    LOCAL_ID,
                    { initProgressCallback: setProgress, appConfig: appConfig }
                );
                aiStatus.textContent = 'Mod√®le expert pr√™t. En attente de donn√©es.';
                analyzeTextBtn.disabled = false;
                analyzeJsonBtn.disabled = false;
            } catch (error) {
                aiStatus.textContent = "Erreur critique lors du chargement du mod√®le IA.";
                console.error("WebLLM Initialization Error:", error);
            }
        }

        // --- AI Analysis Core Logic ---
        const EXPERT_SYSTEM_PROMPT = `
        Tu es un expert tactique, ancien membre d'une unit√© d'intervention sp√©cialis√©e (type PSIG ou GIGN). Tu es reconnu pour ton objectivit√©, ta rigueur et ta capacit√© √† tirer des enseignements concrets de chaque op√©ration.
        Ta mission est d'analyser de mani√®re objective et critique le(s) rapport(s) de Retour d'Exp√©rience (RETEX) qui te sont fournis. Ne te contente pas de r√©sumer. Tu dois √©valuer, interpr√©ter et proposer.
        
        Structure ton analyse IMP√âRATIVEMENT comme suit, en utilisant le format Markdown :
        
        ### 1. Analyse Objective des Faits
        * **Contexte :** R√©sume bri√®vement la situation initiale et la mission.
        * **Chronologie des Actions Cl√©s :** Liste les √©tapes majeures du d√©roulement.
        * **R√©sultat :** D√©cris l'issue de l'op√©ration.
        
        ### 2. √âvaluation du Niveau d'Intervention
        * **Points Forts :** Identifie les d√©cisions, actions ou usages de mat√©riel qui ont √©t√© particuli√®rement efficaces. Sois pr√©cis.
        * **Points Faibles :** Identifie les lacunes, les erreurs ou les moments de flottement.
        
        ### 3. Points de Friction & Axes d'Am√©lioration
        * **Frictions Op√©rationnelles :** Rel√®ve les probl√®mes sp√©cifiques (mat√©riel, proc√©dure, renseignement, etc.).
        * **Suggestions Correctives (court terme) :** Propose des solutions simples et imm√©diates.
        * **Pistes de Travail (long terme) :** Sugg√®re des axes d'am√©lioration plus profonds (entra√Ænements, r√©vision de proc√©dures).
        
        ### 4. Synth√®se et Recommandations Cl√©s
        Fournis une conclusion concise r√©sumant les principaux enseignements et la recommandation la plus importante.
        
        Reste concis, factuel et utilise un langage professionnel.
        `;

        async function runAnalysis(userContent) {
            if (!engine) { alert("Le moteur IA n'est pas encore pr√™t."); return; }
            aiOutput.innerHTML = '';
            analyzeTextBtn.disabled = true;
            analyzeJsonBtn.disabled = true;
            aiStatus.textContent = "Analyse experte en cours...";
            
            try {
                const chunks = await engine.chat.completions.create({
                    stream: true,
                    messages: [
                        { role: "system", content: EXPERT_SYSTEM_PROMPT },
                        { role: "user", content: userContent }
                    ],
                });

                for await (const chunk of chunks) {
                    const delta = chunk.choices[0].delta.content || "";
                    aiOutput.innerHTML += delta.replace(/\n/g, '<br>');
                }
            } catch (error) {
                aiStatus.textContent = "Une erreur est survenue pendant l'analyse.";
                console.error("Analysis Error:", error);
            } finally {
                aiStatus.textContent = "Analyse termin√©e.";
                analyzeTextBtn.disabled = false;
                analyzeJsonBtn.disabled = false;
            }
        }

        // --- Event Listeners for Analysis Buttons ---
        analyzeTextBtn.addEventListener('click', () => {
            const inputText = textInput.value;
            if (!inputText.trim()) { alert("Veuillez saisir un texte √† analyser."); return; }
            const userContent = `Voici le rapport textuel √† analyser :\n\n${inputText}`;
            runAnalysis(userContent);
        });

        analyzeJsonBtn.addEventListener('click', async () => {
            const files = jsonFilesInput.files;
            if (files.length === 0) { alert("Veuillez s√©lectionner au moins un fichier JSON."); return; }
            
            let combinedText = "Voici les rapports JSON √† analyser et synth√©tiser :\n\n";
            for (const file of files) {
                try {
                    const content = await file.text();
                    combinedText += `--- DEBUT RETEX: ${file.name} ---\n`;
                    combinedText += content;
                    combinedText += `\n--- FIN RETEX ---\n\n`;
                } catch (e) {
                    alert(`Le fichier ${file.name} n'a pas pu √™tre lu.`);
                    return;
                }
            }
            runAnalysis(combinedText);
        });

        // --- Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker enregistr√©.'))
                    .catch(err => console.error('Erreur Service Worker:', err));
            });
        }
        
        // --- Start Initialization ---
        initializeWebLLM();
    </script>
</body>
</html>