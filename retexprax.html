<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praxis | Analyse Comparative de RETEX</title>
    <link rel="icon" href="https://oxsilaris06.github.io/Praxis/maskable_icon(2).png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
            --success-green: #27ae60;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 10px; padding-bottom: 90px; }
        .container { width: 100%; max-width: 1200px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        
        h1 { font-size: 2.2em; margin-bottom: 10px; color: var(--accent-blue); font-family: 'Saira Stencil One', sans-serif; text-align: center; }
        h2 { font-size: 1.6em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        p.subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; }

        .section { border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-top: 25px; background-color: var(--bg-interactive); }
        
        #model-loader { text-align: center; }
        #model-loader button { background-color: var(--accent-blue); color: white; padding: 14px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.2em; margin-bottom: 15px; }
        #model-loader button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        #model-status { color: var(--text-secondary); font-style: italic; }
        .progress-bar-container { width: 100%; background-color: var(--bg-body); border-radius: 5px; overflow: hidden; height: 25px; margin-top: 10px; display: none; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--success-green); text-align: center; line-height: 25px; color: white; transition: width 0.3s ease; }

        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 800px) { .upload-grid { grid-template-columns: 1fr; } }
        
        .file-upload-area h3 { color: var(--text-secondary); text-align: center; margin-bottom: 15px; }
        .file-upload-label { background-color: var(--bg-body); border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center;}
        .file-upload-label:hover { border-color: var(--accent-blue); }
        .file-upload-label.loaded { border-color: var(--success-green); border-style: solid; }
        .file-upload-label .material-symbols-outlined { font-size: 30px; color: var(--accent-blue); }
        .file-upload-label p { margin-top: 10px; font-size: 1.1em; }
        .file-name-display { color: var(--success-green); font-weight: bold; margin-top: 10px; }
        input[type="file"] { display: none; }

        #analyze-btn { background-color: var(--success-green); color: white; padding: 14px 40px; border: none; border-radius: 5px; font-family: 'Oswald', sans-serif; font-size: 1.3em; cursor: pointer; width: 100%; margin-top: 20px; }
        #analyze-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        
        #analysis-output { margin-top: 25px; padding: 20px; border: 1px dashed var(--border-color); min-height: 150px; white-space: pre-wrap; font-family: monospace; background-color: var(--bg-body); border-radius: 5px; }
        #analysis-output h3 { color: var(--accent-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-top: 15px; font-family: 'Oswald', sans-serif; font-size: 1.4em;}
        #analysis-output h4 { color: var(--text-secondary); margin-top: 10px; font-family: 'Oswald', sans-serif; font-size: 1.2em;}
        #analysis-output ul { list-style-type: '» '; padding-left: 20px; }
        #analysis-output li { margin-bottom: 8px; }

        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; font-size: 28px; cursor: pointer; text-decoration: none; }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <a href="#" class="dock-menu-item" title="Accueil" onclick="location.reload()"><span class="material-symbols-outlined">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
    </div>

    <div class="container">
        <h1>Praxis</h1>
        <p class="subtitle">Analyse Comparative de Retour d'Expérience</p>

        <div class="section" id="model-loader">
            <h2>1. Initialisation de l'IA Locale</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px; text-align: center;">
                Ce module requiert un modèle d'IA local pour garantir la confidentialité de vos données.
            </p>
            <button id="load-model-btn">Charger le Modèle d'Analyse (≈1 Go)</button>
            <div id="model-status">Statut : Inactif</div>
            <div class="progress-bar-container" id="progress-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
        </div>

        <div class="section" id="file-uploader" style="display:none;">
            <h2>2. Importer les Documents</h2>
            <div class="upload-grid">
                <div class="file-upload-area">
                    <h3>Plan Initial Prévu</h3>
                    <input type="file" id="plan-input" accept=".pdf">
                    <label for="plan-input" class="file-upload-label" id="plan-label">
                        <span class="material-symbols-outlined">picture_as_pdf</span>
                        <p>Chargez le PDF de planification</p>
                        <span class="file-name-display" id="plan-file-name"></span>
                    </label>
                </div>
                <div class="file-upload-area">
                    <h3>Compte-Rendu (RETEX)</h3>
                    <input type="file" id="retex-input" accept=".json,.pdf">
                    <label for="retex-input" class="file-upload-label" id="retex-label">
                        <span class="material-symbols-outlined">article</span>
                        <p>Chargez le fichier RETEX (.json ou .pdf)</p>
                        <span class="file-name-display" id="retex-file-name"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="section" id="analysis-section" style="display:none;">
            <h2>3. Lancer l'Analyse Comparative</h2>
            <button id="analyze-btn" disabled>Comparer les Documents</button>
            <div id="analysis-output" style="display:none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/marked.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        const MODEL_NAME = 'Xenova/LaMini-Flan-T5-77M';
        const TASK = 'text2text-generation';

        const dom = {
            loadModelBtn: document.getElementById('load-model-btn'),
            modelStatus: document.getElementById('model-status'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            fileUploader: document.getElementById('file-uploader'),
            analysisSection: document.getElementById('analysis-section'),
            planInput: document.getElementById('plan-input'),
            retexInput: document.getElementById('retex-input'),
            planLabel: document.getElementById('plan-label'),
            retexLabel: document.getElementById('retex-label'),
            planFileName: document.getElementById('plan-file-name'),
            retexFileName: document.getElementById('retex-file-name'),
            analyzeBtn: document.getElementById('analyze-btn'),
            analysisOutput: document.getElementById('analysis-output'),
            darkModeToggle: document.getElementById('darkModeToggle'),
        };

        let state = {
            generator: null,
            planFile: null,
            retexFile: null,
        };

        async function loadModel() {
            dom.loadModelBtn.disabled = true;
            dom.progressContainer.style.display = 'block';

            try {
                state.generator = await pipeline(TASK, MODEL_NAME, {
                    progress_callback: (p) => {
                        const percentage = p.progress.toFixed(2);
                        dom.progressBar.style.width = percentage + '%';
                        dom.progressBar.textContent = `${percentage}%`;
                        dom.modelStatus.textContent = `Statut : Chargement de "${p.file}"...`;
                    }
                });
                dom.modelStatus.textContent = 'Statut : IA Prête ✔️';
                dom.loadModelBtn.textContent = 'Modèle Chargé';
                dom.fileUploader.style.display = 'block';
                dom.analysisSection.style.display = 'block';
            } catch (error) {
                console.error("Erreur chargement modèle:", error);
                dom.modelStatus.textContent = "Erreur de chargement. Vérifiez la console.";
                dom.loadModelBtn.disabled = false;
            }
        }
        
        function handleFileSelect(event) {
            const inputId = event.target.id;
            const file = event.target.files[0];
            if (!file) return;

            if (inputId === 'plan-input') {
                state.planFile = file;
                dom.planFileName.textContent = file.name;
                dom.planLabel.classList.add('loaded');
            } else if (inputId === 'retex-input') {
                state.retexFile = file;
                dom.retexFileName.textContent = file.name;
                dom.retexLabel.classList.add('loaded');
            }
            updateAnalyzeButtonState();
        }

        function updateAnalyzeButtonState() {
            dom.analyzeBtn.disabled = !(state.generator && state.planFile && state.retexFile);
        }

        async function analyzeDocuments() {
            if (!state.generator || !state.planFile || !state.retexFile) return;
            
            dom.analyzeBtn.disabled = true;
            dom.analysisOutput.style.display = 'block';
            dom.analysisOutput.innerHTML = '<h4>Analyse comparative en cours... Cette opération peut prendre un moment.</h4>';

            try {
                // Extraire le texte des deux documents en parallèle
                const [planText, retexText] = await Promise.all([
                    extractTextFromFile(state.planFile),
                    extractTextFromFile(state.retexFile)
                ]);

                // Création du prompt comparatif
                const prompt = `
                    Tu es un analyste tactique expert. Ta mission est de comparer un document de planification d'opération avec le compte-rendu (RETEX) de cette même opération.
                    
                    **Contexte Important :** Le document "PLAN INITIAL" contient du texte mais aussi des éléments visuels (cartes, photos) que tu ne peux pas voir. Base ton analyse uniquement sur les informations textuelles fournies.

                    Voici le contenu des documents :

                    --- DÉBUT DU PLAN INITIAL ---
                    ${planText}
                    --- FIN DU PLAN INITIAL ---

                    --- DÉBUT DU COMPTE-RENDU (RETEX) ---
                    ${retexText}
                    --- FIN DU COMPTE-RENDU (RETEX) ---

                    **Ta Tâche :**
                    Produis une synthèse claire et structurée au format Markdown qui compare le plan à la réalité du terrain. Organise ta réponse comme suit :

                    ### Analyse Comparative de l'Opération

                    #### 1. Points de Convergence (Ce qui s'est déroulé comme prévu)
                    Liste ici les éléments de la mission où le RETEX confirme que le plan a été suivi avec succès.

                    #### 2. Écarts et Divergences (Ce qui a changé)
                    Liste les différences notables entre le plan et le déroulé réel. Mentionne les imprévus, les changements de tactique, et les résultats inattendus.

                    #### 3. Enseignements Clés et Recommandations
                    Basé sur les écarts, quels sont les principaux enseignements à tirer ? Propose des recommandations concrètes pour les futures opérations.
                `;
                
                // Lancement de la génération
                const result = await state.generator(prompt, {
                    max_new_tokens: 1024, // Augmenté pour une analyse plus complète
                    temperature: 0.5,
                    repetition_penalty: 1.2,
                });
                
                const generatedText = result[0].generated_text;
                dom.analysisOutput.innerHTML = marked.parse(generatedText);

            } catch (error) {
                console.error("Erreur durant l'analyse:", error);
                dom.analysisOutput.textContent = "Une erreur est survenue pendant l'analyse comparative.";
            } finally {
                dom.analyzeBtn.disabled = false;
            }
        }
        
        async function extractTextFromFile(file) {
            if (file.type === 'application/json') {
                return file.text();
            } else if (file.type === 'application/pdf') {
                const arrayBuffer = await file.arrayBuffer();
                const typedarray = new Uint8Array(arrayBuffer);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let textContent = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const text = await page.getTextContent();
                    textContent += text.items.map(s => s.str).join(' ') + '\n';
                }
                return textContent;
            }
            return `Type de fichier non supporté: ${file.name}`;
        }

        // --- Écouteurs d'événements ---
        dom.loadModelBtn.addEventListener('click', loadModel);
        dom.planInput.addEventListener('change', handleFileSelect);
        dom.retexInput.addEventListener('change', handleFileSelect);
        dom.analyzeBtn.addEventListener('click', analyzeDocuments);
        
        dom.darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.replace('dark-mode', 'light-mode');
                document.getElementById('darkModeIcon').textContent = 'clear_day';
            }
        });
    </script>
</body>
</html>
