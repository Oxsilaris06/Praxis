<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RETEXT - Analyseur Tactique</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-green: #27ae60; --disabled-bg: #444; --error-red: #c0392b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 20px; }
        .container { width: 100%; max-width: 900px; margin: auto; background: var(--bg-container); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); }
        
        .header { text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { font-weight: 500; color: var(--accent-blue); margin-bottom: 15px; }
        
        button { font-family: 'Oswald', sans-serif; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; padding: 12px 20px; display: inline-flex; align-items: center; justify-content: center; gap: 10px; transition: background-color 0.3s; }
        button:disabled { cursor: not-allowed; background-color: var(--disabled-bg) !important; color: var(--text-secondary) !important; }
        
        #load-model-btn { background-color: var(--accent-blue); color: white; width: 100%; }
        
        /* --- NOUVELLE SECTION : Barre de chargement --- */
        #loading-section { margin-top: 15px; text-align: left; }
        #loading-text { color: var(--text-secondary); font-style: italic; margin-bottom: 8px; font-size: 0.9em; }
        .progress-bar-container { width: 100%; background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; }
        #progress-bar-fill { height: 20px; width: 0%; background-color: var(--accent-blue); transition: width 0.3s ease-out, background-color 0.5s ease; text-align: center; line-height: 20px; color: white; font-size: 0.8em; }
        #progress-bar-fill.ready { background-color: var(--accent-green); }
        #progress-bar-fill.error { background-color: var(--error-red); }
        /* --- FIN DE LA NOUVELLE SECTION --- */

        .toggle-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-interactive); transition: .4s; border-radius: 34px; border: 1px solid var(--border-color); }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-green); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .action-button { background-color: var(--accent-green); color: white; width: 100%; }
        textarea { width: 100%; min-height: 250px; background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; font-family: sans-serif; font-size: 1rem; margin-bottom: 15px; }
        
        .output-area { margin-top: 20px; background-color: var(--bg-body); border: 1px solid var(--border-color); border-radius: 5px; padding: 15px; min-height: 200px; white-space: pre-wrap; font-family: sans-serif; line-height: 1.7; color: var(--text-secondary); }
        #file-list-display { list-style: none; padding: 0; margin-top: 15px; font-family: monospace; max-height: 100px; overflow-y: auto; }
        #file-list-display li { background-color: var(--bg-interactive); padding: 5px 8px; border-radius: 3px; margin-bottom: 5px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analyseur Tactique RETEX</h1>
            <button id="load-model-btn"><span class="material-symbols-outlined">memory</span>Charger le Mod√®le Expert (Phi-3)</button>
            <div id="loading-section">
                <div id="loading-text">Cliquez sur le bouton pour d√©marrer le chargement.</div>
                <div class="progress-bar-container">
                    <div id="progress-bar-fill"></div>
                </div>
            </div>
        </div>

        <div class="toggle-container">
            <span>Analyse JSON</span>
            <label class="toggle-switch">
                <input type="checkbox" id="mode-toggle">
                <span class="slider"></span>
            </label>
            <span>Analyse Texte</span>
        </div>

        <!-- VIEW 1: JSON ANALYSIS -->
        <div id="json-view" class="view active">
            <input type="file" id="json-file-input" multiple accept=".json" style="display:none;">
            <button id="upload-json-btn" class="action-button" disabled><span class="material-symbols-outlined">upload_file</span>Charger Fichier(s) RETEX .json</button>
            <ul id="file-list-display"></ul>
            <div id="json-output" class="output-area">En attente de l'analyse des fichiers...</div>
        </div>

        <!-- VIEW 2: TEXT ANALYSIS -->
        <div id="text-view" class="view">
            <textarea id="text-input" placeholder="Collez ici le rapport brut √† analyser..."></textarea>
            <button id="analyze-text-btn" class="action-button" disabled><span class="material-symbols-outlined">edit_document</span>Analyser le Texte</button>
            <div id="text-output" class="output-area">En attente de l'analyse du texte...</div>
        </div>
    </div>
    
    <script type="module">
        import { CreateWebWorkerMLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/wasm/web-llm.js";

        // --- DOM Elements ---
        const loadModelBtn = document.getElementById('load-model-btn');
        const loadingText = document.getElementById('loading-text');
        const progressBarFill = document.getElementById('progress-bar-fill');
        
        const modeToggle = document.getElementById('mode-toggle');
        const jsonView = document.getElementById('json-view');
        const textView = document.getElementById('text-view');
        const uploadJsonBtn = document.getElementById('upload-json-btn');
        const jsonFileInput = document.getElementById('json-file-input');
        const fileListDisplay = document.getElementById('file-list-display');
        const jsonOutput = document.getElementById('json-output');
        const textInput = document.getElementById('text-input');
        const analyzeTextBtn = document.getElementById('analyze-text-btn');
        const textOutput = document.getElementById('text-output');

        let engine;
        let isModelReady = false;

        // --- MISE √Ä JOUR : Gestion de la barre de progression ---
        const progressCallback = (report) => {
            const progress = (report.progress * 100).toFixed(0);
            let userFriendlyText = "Pr√©paration de l'environnement d'analyse...";
            if (report.text.includes("fetch")) {
                userFriendlyText = "T√©l√©chargement du mod√®le expert...";
            } else if (report.text.includes("instantiate")) {
                userFriendlyText = "Configuration et installation de l'IA...";
            }
            
            loadingText.textContent = `${userFriendlyText} (${progress}%)`;
            progressBarFill.style.width = `${progress}%`;
            progressBarFill.textContent = `${progress}%`;
        };
        // --- FIN DE LA MISE √Ä JOUR ---

        loadModelBtn.addEventListener('click', async () => {
            if (isModelReady) return;
            loadModelBtn.disabled = true;

            const GGUF_MODEL_URL = "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-gguf/resolve/main/Phi-3-mini-4k-instruct-q4.gguf";
            const WASM_URL = "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/lib/wasm/phi-3-mini-4k-instruct.wasm";
            const LOCAL_ID = "Phi-3-mini-4k-instruct-q4-gguf";

            try {
                engine = await CreateWebWorkerMLCEngine(
                    new Worker(new URL('./web-llm-worker.js', import.meta.url), { type: 'module' }),
                    LOCAL_ID,
                    {
                        initProgressCallback: progressCallback,
                        appConfig: { model_list: [{"model_url": GGUF_MODEL_URL, "local_id": LOCAL_ID, "model_lib_url": WASM_URL}] }
                    }
                );
                
                isModelReady = true;
                loadingText.textContent = 'IA Experte Op√©rationnelle';
                progressBarFill.style.width = '100%';
                progressBarFill.textContent = 'PR√äTE';
                progressBarFill.classList.add('ready');
                loadModelBtn.textContent = 'Mod√®le Pr√™t';
                
                uploadJsonBtn.disabled = false;
                analyzeTextBtn.disabled = false;

            } catch (error) {
                loadingText.textContent = "Erreur critique de chargement. Veuillez rafra√Æchir la page.";
                progressBarFill.style.width = '100%';
                progressBarFill.classList.add('error');
                progressBarFill.textContent = 'ERREUR';
                loadModelBtn.textContent = '√âchec du chargement (R√©essayer)';
                loadModelBtn.disabled = false;
                console.error("WebLLM Init Error:", error);
            }
        });

        modeToggle.addEventListener('change', () => {
            jsonView.classList.toggle('active');
            textView.classList.toggle('active');
        });

        uploadJsonBtn.addEventListener('click', () => jsonFileInput.click());
        
        jsonFileInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;
            
            fileListDisplay.innerHTML = '';
            Array.from(files).forEach(file => {
                const li = document.createElement('li');
                li.textContent = `üìÑ ${file.name}`;
                fileListDisplay.appendChild(li);
            });

            jsonOutput.textContent = 'Compilation des rapports...';
            let combinedText = "Voici les rapports JSON √† analyser et synth√©tiser :\n\n";
            for (const file of files) {
                try {
                    const content = await file.text();
                    combinedText += `--- DEBUT RETEX: ${file.name} ---\n${content}\n--- FIN RETEX ---\n\n`;
                } catch (e) {
                    jsonOutput.textContent = `Erreur de lecture du fichier ${file.name}.`;
                    return;
                }
            }
            await runAnalysis(combinedText, jsonOutput);
        });
        
        analyzeTextBtn.addEventListener('click', async () => {
            const inputText = textInput.value;
            if (!inputText.trim()) { alert("Veuillez saisir un texte √† analyser."); return; }
            const userContent = `Voici le rapport textuel √† analyser :\n\n${inputText}`;
            await runAnalysis(userContent, textOutput);
        });

        const EXPERT_SYSTEM_PROMPT = `
        Tu es un expert tactique, ancien membre d'une unit√© d'intervention sp√©cialis√©e (type PSIG ou GIGN). Tu es reconnu pour ton objectivit√©, ta rigueur et ta capacit√© √† tirer des enseignements concrets de chaque op√©ration.
        Ta mission est d'analyser de mani√®re objective et critique le(s) rapport(s) de Retour d'Exp√©rience (RETEX) qui te sont fournis. Ne te contente pas de r√©sumer. Tu dois √©valuer, interpr√©ter et proposer.
        
        Structure ton analyse IMP√âRATIVEMENT comme suit, en utilisant le format Markdown :
        
        ### 1. Analyse Objective des Faits
        * **Contexte :** R√©sume bri√®vement la situation initiale et la mission.
        * **Chronologie des Actions Cl√©s :** Liste les √©tapes majeures du d√©roulement.
        * **R√©sultat :** D√©cris l'issue de l'op√©ration.
        
        ### 2. √âvaluation du Niveau d'Intervention
        * **Points Forts :** Identifie les d√©cisions, actions ou usages de mat√©riel qui ont √©t√© particuli√®rement efficaces.
        * **Points Faibles :** Identifie les lacunes, les erreurs ou les moments de flottement.
        
        ### 3. Points de Friction & Axes d'Am√©lioration
        * **Frictions Op√©rationnelles :** Rel√®ve les probl√®mes sp√©cifiques (mat√©riel, proc√©dure, renseignement, etc.).
        * **Suggestions Correctives (court terme) :** Propose des solutions simples et imm√©diates.
        * **Pistes de Travail (long terme) :** Sugg√®re des axes d'am√©lioration plus profonds (entra√Ænements, r√©vision de proc√©dures).
        
        ### 4. Synth√®se et Recommandations Cl√©s
        Fournis une conclusion concise r√©sumant les principaux enseignements et la recommandation la plus importante.
        
        Reste concis, factuel et utilise un langage professionnel.
        `;

        async function runAnalysis(userContent, outputElement) {
            if (!isModelReady) { alert("Veuillez d'abord charger le mod√®le expert."); return; }
            outputElement.innerHTML = 'Analyse experte en cours...';
            
            try {
                const chunks = await engine.chat.completions.create({
                    stream: true,
                    messages: [
                        { role: "system", content: EXPERT_SYSTEM_PROMPT },
                        { role: "user", content: userContent }
                    ],
                });

                let fullResponse = "";
                for await (const chunk of chunks) {
                    const delta = chunk.choices[0].delta.content || "";
                    fullResponse += delta;
                    // Formatage simple pour l'affichage en direct
                    let formattedHtml = fullResponse.replace(/\n/g, '<br>');
                    formattedHtml = formattedHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    outputElement.innerHTML = formattedHtml;
                }
            } catch (error) {
                outputElement.textContent = "Une erreur est survenue pendant l'analyse.";
                console.error("Analysis Error:", error);
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker enregistr√©.'))
                    .catch(err => console.error('Erreur Service Worker:', err));
            });
        }
    </script>
</body>
</html>
