<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategica - Analyse Tactique IA Locale (MLC Web-LLM)</title>
	<link rel="icon" href="maskable_icon(2).png" sizes="any" type="image/png">
    <link rel="icon" href="maskable_icon(2).png" type="image/svg+xml">
    <link rel="apple-touch-icon" href="maskable_icon(2).png">
    <link rel="manifest" href="site.webmanifest">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* CSS REUTILIS√â DE PRAXIS.HTML */
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
            --success-green: #27ae60;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 10px; padding-bottom: 90px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 2.2em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Saira+Stencil+One', sans-serif; text-align: center; letter-spacing: 1.5px; font-weight: 400; }
        h2 { font-size: 1.4em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        /* Style sp√©cifique pour Strategica */
        #modelStatus { margin-top: 10px; font-style: italic; color: var(--text-secondary); text-align: center; }
        #strategicaForm label { font-weight: bold; color: var(--text-primary); margin-top: 15px; margin-bottom: 5px; display: block; }
        #strategicaForm textarea { width: 100%; padding: 10px; min-height: 150px; background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Oswald', sans-serif; resize: vertical; }
        .action-button { background-color: var(--accent-blue); color: white; padding: 14px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; width: 100%; margin-top: 20px; }
        .action-button:hover:not(:disabled) { background-color: var(--accent-hover); }
        .action-button:disabled { background-color: var(--bg-interactive); color: var(--text-secondary); cursor: not-allowed; }
        #analysisOutput { 
            margin-top: 20px; padding: 15px; border: 1px dashed var(--accent-blue); 
            border-radius: 5px; background-color: var(--bg-interactive); min-height: 200px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        #analysisOutput h3 { color: var(--accent-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        /* Rendu Markdown dans la zone de sortie */
        #analysisOutput p { margin-bottom: 8px; }
        #analysisOutput ul { list-style-type: disc; padding-left: 20px; margin-bottom: 15px; }
        #analysisOutput strong { color: var(--danger-red); }

        /* Styles du Dock Menu r√©utilis√©s */
        .dock-menu { 
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 10px; padding: 10px; z-index: 1000; 
            background-color: rgba(30, 30, 30, 0.7); 
            border: 1px solid var(--border-color); 
            border-radius: 35px; backdrop-filter: blur(10px); 
            transition: all 0.3s ease-in-out; 
        }
        .dock-menu-item { 
            display: flex; align-items: center; justify-content: center; 
            background-color: var(--bg-container); color: var(--text-primary); 
            border: 1px solid var(--border-color); 
            border-radius: 50%; width: 50px; height: 50px; 
            font-size: 28px; cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            transition: all 0.2s; text-decoration: none; flex-shrink: 0; 
        }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { 
            width: 55px; height: 55px; padding: 5px; 
            border-radius: 50%; border: none; 
            background-color: transparent; 
        }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { 
            opacity: 0; width: 0; margin-left: -10px; visibility: hidden; 
        }
        #dockToggleBtn .material-symbols-outlined { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-symbols-outlined { transform: rotate(180deg); }
        
        @media (max-width: 600px) {
            .dock-menu:not(.collapsed) { width: 95%; padding: 5px; gap: 5px; justify-content: center; display: flex; flex-wrap: wrap; }
            .dock-menu:not(.collapsed) .dock-menu-item { width: 45px; height: 45px; font-size: 24px; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="R√©duire"><span class="material-symbols-outlined">expand_more</span></div>
        <a href="praxis.html" class="dock-menu-item" title="Accueil Praxis"><span class="material-symbols-outlined">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le th√®me"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
    </div>

    <input type="file" id="retexFileInput" accept=".json" multiple style="display: none;" />

    <div class="container">
        <h1>Strategica</h1>
        <p style="text-align: center; color: var(--text-secondary);">Module d'Analyse Tactique Locale par IA</p>
        
        <div id="modelStatus">Initialisation du Moteur IA...</div>
        
        <form id="strategicaForm">
            <h2>1. Donn√©es de l'Op√©ration</h2>
            <div style="border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; background-color: var(--bg-interactive);">
                <label for="oiDataDisplay">Ordre Initial (OI) - R√©cup√©r√© de la session locale</label>
                <textarea id="oiDataDisplay" rows="10" readonly placeholder="Les donn√©es de l'OI (situation, articulation, etc.) seront charg√©es ici depuis la session."></textarea>
                <button type="button" id="loadOiBtn" class="action-button" style="background-color: var(--success-green); margin-top: 10px;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">sync</span> Charger OI de la session
                </button>
            </div>
            
            <h2>2. Donn√©es du Retour d'Exp√©rience (RETEX)</h2>
            <div style="border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; background-color: var(--bg-interactive);">
                <label for="retexFileNames">Fichiers RETEX (.json) √† analyser</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" id="selectRetexFilesBtn" class="action-button" style="background-color: var(--accent-blue); flex-grow: 1; margin-top: 0;">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">upload_file</span> S√©lectionner Fichiers
                    </button>
                    <span id="retexFileNames" class="file-name-display" style="flex-grow: 2; margin-top: 0; color: var(--text-secondary); white-space: normal;">Aucun fichier s√©lectionn√©</span>
                </div>
                <textarea id="retexDataDisplay" rows="10" readonly placeholder="Les donn√©es consolid√©es des RETEX s'afficheront ici."></textarea>
            </div>
            
            <h2>3. Consigne pour l'IA</h2>
            <label for="aiPrompt">Instructions d'analyse</label>
            <textarea id="aiPrompt" rows="8">Tu es un analyste tactique de la Gendarmerie. Ton r√¥le est de synth√©tiser les donn√©es de l'Ordre Initial (OI) et du Retour d'Exp√©rience (RETEX) pour en tirer des le√ßons.

R√©dige ta r√©ponse *uniquement en fran√ßais*. En t'appuyant uniquement sur les donn√©es structur√©es fournies ci-dessous:
1.  **Synth√®se:** R√©sume l'√©cart entre le plan (OI) et l'ex√©cution (RETEX).
2.  **Points Cl√©s (Forces/Faiblesses):** Identifie 3 points forts et 3 points faibles clairs de l'op√©ration.
3.  **Am√©lioration:** Propose une recommandation tactique concr√®te.

Formate ta r√©ponse en Markdown. Utilise des listes √† puces et commence par "### Analyse Strat√©gica". S'il manque des donn√©es, indique RAS (Rien √Ä Signaler).</textarea>
            
            <button type="button" id="launchAnalysisBtn" disabled>
                <span class="material-symbols-outlined" style="vertical-align: middle;">memory</span> Lancer l'Analyse (Localement)
            </button>
        </form>
        
        <h2>4. Rapport d'Analyse</h2>
        <div id="analysisOutput">
            Le rapport d'analyse de l'IA appara√Ætra ici.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/marked.min.js"></script>
    
    <script src="https://esm.run/@mlc-ai/web-llm@0.2.49"></script>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // --- Variables Globales ---
        let aiEngine = null;
        let workerInitialized = false;
        let oiData = null;
        let retexData = null;
        
        // üîë Mod√®le cible stable recommand√© par MLC pour le navigateur
        const modelID = "Phi-3-mini-4k-instruct-q4f32"; 
        
        // --- 1. Gestion du statut de chargement ---
        function updateEngineInitProgressCallback(report) {
             const modelStatus = document.getElementById('modelStatus');
             if (report.progress < 1) {
                 // Affiche le statut d√©taill√© pendant le t√©l√©chargement/compilation
                 modelStatus.textContent = `T√©l√©chargement : ${(report.progress * 100).toFixed(1)}% - ${report.text}`;
             } else {
                 modelStatus.textContent = `Compilation termin√©e. D√©marrage du moteur...`;
             }
         }


        // --- 2. Initialisation du Web Worker et de l'Engine (Utilisation du constructeur) ---
        async function initializeEngine() {
            const modelStatus = document.getElementById('modelStatus');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');
            modelStatus.textContent = `Chargement du moteur Web-LLM (Mod√®le: ${modelID})...`;
            
            try {
                // 1. Cr√©er le moteur MLC (ex√©cute automatiquement en Web Worker)
                aiEngine = new webllm.MLCEngine();
                
                // 2. Attacher le callback de progression
                aiEngine.setInitProgressCallback(updateEngineInitProgressCallback);
                
                modelStatus.textContent = `Moteur cr√©√©. D√©marrage du t√©l√©chargement du mod√®le ${modelID}...`;

                // 3. Charger le mod√®le (d√©clenche le t√©l√©chargement et la compilation)
                await aiEngine.reload(modelID, {
                    chatOpts: {
                        repetition_penalty: 1.05
                    }
                });

                workerInitialized = true;
                modelStatus.textContent = `Moteur Web-LLM Pr√™t! (Mod√®le: ${modelID}) ‚úÖ`;
                
                // V√©rifier si les donn√©es sont d√©j√† charg√©es pour activer le bouton
                if (oiData && retexData && retexData.length > 0) {
                    if (launchAnalysisBtn) launchAnalysisBtn.disabled = false;
                }

            } catch (e) {
                let errorMessage = e.message;
                if (e.message.includes('WebGPU') || e.message.includes('WebAssembly')) {
                    errorMessage = "Probl√®me de ressource mat√©rielle. Assurez-vous que WebGPU est activ√© et que la RAM est suffisante.";
                } else if (e.message.includes('Cannot find model record')) {
                    // Cette erreur est captur√©e en amont (l'engine ne peut √™tre cr√©√© si config.json n'est pas charg√©)
                    errorMessage = "Fichier de configuration de base MLC manquant. V√©rifiez la connexion internet et le cache.";
                }
                modelStatus.textContent = `‚ùå √âchec critique Web-LLM : ${errorMessage}`;
                console.error("Erreur de cr√©ation du moteur MLC:", e);
            }
        }

        // --- 5. Fonction principale d'analyse (Utilise le moteur MLC) ---
        async function launchAnalysis() {
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');
            const analysisOutput = document.getElementById('analysisOutput');

            if (!workerInitialized) { 
                analysisOutput.innerHTML = '<p class="text-danger">Le moteur IA n\'est pas pr√™t. Veuillez r√©essayer le chargement.</p>';
                return; 
            }
            if (!oiData || !retexData || retexData.length === 0) { 
                analysisOutput.innerHTML = '<p>Veuillez charger les donn√©es de l\'OI et au moins un fichier RETEX JSON.</p>';
                return; 
            }

            launchAnalysisBtn.disabled = true;
            launchAnalysisBtn.textContent = 'Analyse en cours sur Web Worker...';
            analysisOutput.innerHTML = '<p style="text-align:center;">L\'analyse est en cours sur le Worker. Le site reste fluide.</p>';

            const aiPrompt = document.getElementById('aiPrompt').value;

            // üîë Construction du prompt optimis√© pour la stabilit√© et les mod√®les instruct
            const fullPrompt = `
[INSTRUCTION]
${aiPrompt}

[DONN√âES ORDRE INITIAL (OI)]
${JSON.stringify(oiData, null, 2)}

[DONN√âES RETOUR D'EXP√âRIENCE (RETEX) - ${retexData.length} RAPPORT(S)]
${JSON.stringify(retexData, null, 2)}
`;
            
            // Format de chat standard pour Phi-3
            const messages = [
                { role: "system", content: "Vous √™tes un analyste tactique de la Gendarmerie Fran√ßaise, professionnel et factuel. Votre t√¢che est de synth√©tiser les documents fournis. R√©pondez de mani√®re concise et factuelle. Commencez votre r√©ponse directement par '### Analyse Strat√©gica'." },
                { role: "user", content: fullPrompt }
            ];

            try {
                // Utiliser la m√©thode `chat.completions.create` (m√©thode non streaming)
                const completion = await aiEngine.chat.completions.create({
                    messages: messages,
                    stream: false,
                    max_tokens: 512,
                    repetition_penalty: 1.05
                });

                let generatedText = completion.choices[0].message.content || "Erreur de g√©n√©ration.";
                
                // Nettoyage de la sortie g√©n√©r√©e
                const responseStartMarker = "### Analyse Strat√©gica";
                let startIndex = generatedText.indexOf(responseStartMarker);
                
                if (startIndex !== -1) {
                    generatedText = generatedText.substring(startIndex).trim();
                } else {
                    generatedText = `‚ö†Ô∏è **SORTIE BRUTE NON FORMAT√âE** ‚ö†Ô∏è
                    Le mod√®le n'a pas respect√© le marqueur de d√©but. Voici la sortie compl√®te g√©n√©r√©e :
                    \n\n${generatedText}`;
                }

                // Rendu Markdown
                analysisOutput.innerHTML = window.marked.parse(generatedText);

            } catch (e) {
                analysisOutput.innerHTML = `<p style="color: var(--danger-red);">üî¥ **ERREUR D'INF√âRENCE MLC** üî¥<br>Le processus a √©chou√©. Cause : ${e.message}</p>`;
                console.error("Erreur d'inf√©rence MLC:", e);
            } finally {
                launchAnalysisBtn.disabled = false;
                launchAnalysisBtn.textContent = 'Lancer l\'Analyse (Localement)';
            }
        }


        // --- 2. Chargement des donn√©es OI depuis localStorage ---
        function loadOiData() {
            const dataString = localStorage.getItem('oiFormData');
            const oiDataDisplay = document.getElementById('oiDataDisplay');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');
            
            if (!dataString) {
                oiDataDisplay.value = "Erreur: Aucune donn√©e 'oiFormData' trouv√©e dans la session locale (localStorage). Veuillez d'abord remplir le formulaire Praxis.";
                oiData = null;
                if (launchAnalysisBtn) launchAnalysisBtn.disabled = true;
                return null;
            }
            try {
                const fullOiData = JSON.parse(dataString);
                
                const relevantData = {
                    situation: {
                        generale: fullOiData.situation_generale,
                        particuliere: fullOiData.situation_particuliere,
                    },
                    adversaire: {
                        nom: fullOiData.nom_adversaire,
                        domicile: fullOiData.domicile_adversaire,
                        etat_esprit: fullOiData.etat_esprit_list ? fullOiData.etat_esprit_list.join(', ') : 'RAS',
                        volume: fullOiData.volume_list ? fullOiData.volume_list.join(', ') : 'RAS',
                        armes: fullOiData.armes_connues,
                        me: fullOiData.me_list ? fullOiData.me_list.join(', ') : 'RAS',
                    },
                    execution: {
                        date: fullOiData.date_execution,
                        heure: fullOiData.heure_execution,
                        type_action: fullOiData.type_action,
                        hypotheses: [fullOiData.hypothese_h1, fullOiData.hypothese_h2, fullOiData.hypothese_h3].filter(Boolean).join(' / '),
                        chronologie: fullOiData.time_events ? fullOiData.time_events.map(e => `${e.type} √† ${e.hour}: ${e.description}`).join('; ') : 'RAS',
                    },
                    articulation_india: {
                        mission: fullOiData.india_mission,
                        cat: fullOiData.india_cat,
                    },
                    articulation_ao: {
                        mission: fullOiData.ao_mission,
                        cat: fullOiData.ao_cat,
                    },
                    patracdvr_composition: fullOiData.patracdvr_rows ? fullOiData.patracdvr_rows.flatMap(row => row.members).map(m => `${m.trigramme} (${m.cellule}, ${m.fonction})`).join('; ') : 'RAS',
                };

                const formattedText = JSON.stringify(relevantData, null, 2);
                oiDataDisplay.value = `Donn√©es OI charg√©es pour l'analyse: \n\n${formattedText}`;
                
                oiData = relevantData; 
                
                if (workerInitialized && retexData && retexData.length > 0) {
                    if (launchAnalysisBtn) launchAnalysisBtn.disabled = false;
                }
                
                return relevantData;
            } catch (e) {
                oiDataDisplay.value = `Erreur de parsing des donn√©es OI : ${e.message}`;
                console.error(e);
                oiData = null;
                if (launchAnalysisBtn) launchAnalysisBtn.disabled = true;
                return null;
            }
        }

        // --- 3. Gestion de l'importation des fichiers RETEX ---
        function handleRetexFilesChange(event) {
            const files = event.target.files;
            const retexFileNames = document.getElementById('retexFileNames');
            const retexDataDisplay = document.getElementById('retexDataDisplay');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');

            if (files.length === 0) {
                retexFileNames.textContent = 'Aucun fichier s√©lectionn√©';
                retexDataDisplay.value = '';
                retexData = [];
                if (launchAnalysisBtn) launchAnalysisBtn.disabled = true;
                return;
            }
            
            retexFileNames.textContent = `${files.length} fichier(s) s√©lectionn√©(s). Lecture en cours...`;

            let allReports = [];
            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            allReports.push(jsonData);
                        } catch (error) {
                            console.error(`Erreur de lecture du fichier ${file.name}:`, error);
                        }
                        resolve();
                    };
                    reader.onerror = () => resolve();
                    reader.readAsText(file);
                });
            });

            Promise.all(promises).then(() => {
                retexData = allReports;
                retexFileNames.textContent = `${allReports.length} rapport(s) JSON valide(s) charg√©(s).`;
                retexDataDisplay.value = `Donn√©es RETEX consolid√©es (${allReports.length} rapports): \n\n${JSON.stringify(allReports, null, 2)}`;
                
                if (workerInitialized && oiData && retexData.length > 0) {
                    if (launchAnalysisBtn) launchAnalysisBtn.disabled = false;
                } else {
                    if (launchAnalysisBtn) launchAnalysisBtn.disabled = true;
                }
            });
        }
        
        // --- √âv√©nements et Initialisation du Module ---
        document.addEventListener('DOMContentLoaded', () => {
            const loadOiBtn = document.getElementById('loadOiBtn');
            const selectRetexFilesBtn = document.getElementById('selectRetexFilesBtn');
            const retexFileInput = document.getElementById('retexFileInput');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');

            // 1. D√©marrer l'Engine MLC
            initializeEngine();
            
            // 2. Gestion des Boutons
            if (loadOiBtn) loadOiBtn.addEventListener('click', loadOiData);
            if (selectRetexFilesBtn) selectRetexFilesBtn.addEventListener('click', () => retexFileInput.click());
            if (retexFileInput) retexFileInput.addEventListener('change', handleRetexFilesChange);
            if (launchAnalysisBtn) launchAnalysisBtn.addEventListener('click', launchAnalysis);
            
            // Tentative de chargement initial de l'OI
            loadOiData();
        });
    </script>
</body>
</html>
