<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategica - Analyse Tactique IA Locale</title>
	<link rel="icon" href="maskable_icon(2).png" sizes="any" type="image/png">
    <link rel="icon" href="maskable_icon(2).png" type="image/svg+xml">
    <link rel="apple-touch-icon" href="maskable_icon(2).png">
    <link rel="manifest" href="site.webmanifest">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* CSS REUTILISÉ DE PRAXIS.HTML */
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
            --success-green: #27ae60;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 10px; padding-bottom: 90px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 2.2em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Saira Stencil One', sans-serif; text-align: center; letter-spacing: 1.5px; font-weight: 400; }
        h2 { font-size: 1.4em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        /* Style spécifique pour Strategica */
        #modelStatus { margin-top: 10px; font-style: italic; color: var(--text-secondary); text-align: center; }
        #strategicaForm label { font-weight: bold; color: var(--text-primary); margin-top: 15px; margin-bottom: 5px; display: block; }
        #strategicaForm textarea { width: 100%; padding: 10px; min-height: 150px; background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Oswald', sans-serif; resize: vertical; }
        .action-button { background-color: var(--accent-blue); color: white; padding: 14px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; width: 100%; margin-top: 20px; }
        .action-button:hover:not(:disabled) { background-color: var(--accent-hover); }
        .action-button:disabled { background-color: var(--bg-interactive); color: var(--text-secondary); cursor: not-allowed; }
        #analysisOutput { 
            margin-top: 20px; padding: 15px; border: 1px dashed var(--accent-blue); 
            border-radius: 5px; background-color: var(--bg-interactive); min-height: 200px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        #analysisOutput h3 { color: var(--accent-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        
        /* Styles du Dock Menu réutilisés */
        .dock-menu { 
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 10px; padding: 10px; z-index: 1000; 
            background-color: rgba(30, 30, 30, 0.7); 
            border: 1px solid var(--border-color); 
            border-radius: 35px; backdrop-filter: blur(10px); 
            transition: all 0.3s ease-in-out; 
        }
        .dock-menu-item { 
            display: flex; align-items: center; justify-content: center; 
            background-color: var(--bg-container); color: var(--text-primary); 
            border: 1px solid var(--border-color); 
            border-radius: 50%; width: 50px; height: 50px; 
            font-size: 28px; cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            transition: all 0.2s; text-decoration: none; flex-shrink: 0; 
        }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { 
            width: 55px; height: 55px; padding: 5px; 
            border-radius: 50%; border: none; 
            background-color: transparent; 
        }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { 
            opacity: 0; width: 0; margin-left: -10px; visibility: hidden; 
        }
        #dockToggleBtn .material-symbols-outlined { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-symbols-outlined { transform: rotate(180deg); }
        
        @media (max-width: 600px) {
            .dock-menu:not(.collapsed) { width: 95%; padding: 5px; gap: 5px; justify-content: center; display: flex; flex-wrap: wrap; }
            .dock-menu:not(.collapsed) .dock-menu-item { width: 45px; height: 45px; font-size: 24px; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="Réduire"><span class="material-symbols-outlined">expand_more</span></div>
        <a href="praxis.html" class="dock-menu-item" title="Accueil Praxis"><span class="material-symbols-outlined">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
    </div>

    <input type="file" id="retexFileInput" accept=".json" multiple style="display: none;" />

    <div class="container">
        <h1>Strategica</h1>
        <p style="text-align: center; color: var(--text-secondary);">Module d'Analyse Tactique Locale par IA</p>
        
        <div id="modelStatus">Chargement du modèle d'IA...</div>
        
        <form id="strategicaForm">
            <h2>1. Données de l'Opération</h2>
            <div style="border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; background-color: var(--bg-interactive);">
                <label for="oiDataDisplay">Ordre Initial (OI) - Récupéré de la session locale</label>
                <textarea id="oiDataDisplay" rows="10" readonly placeholder="Les données de l'OI (situation, articulation, etc.) seront chargées ici depuis la session."></textarea>
                <button type="button" id="loadOiBtn" class="action-button" style="background-color: var(--success-green); margin-top: 10px;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">sync</span> Charger OI de la session
                </button>
            </div>
            
            <h2>2. Données du Retour d'Expérience (RETEX)</h2>
            <div style="border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; background-color: var(--bg-interactive);">
                <label for="retexFileNames">Fichiers RETEX (.json) à analyser</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" id="selectRetexFilesBtn" class="action-button" style="background-color: var(--accent-blue); flex-grow: 1; margin-top: 0;">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">upload_file</span> Sélectionner Fichiers
                    </button>
                    <span id="retexFileNames" class="file-name-display" style="flex-grow: 2; margin-top: 0; color: var(--text-secondary); white-space: normal;">Aucun fichier sélectionné</span>
                </div>
                <textarea id="retexDataDisplay" rows="10" readonly placeholder="Les données consolidées des RETEX s'afficheront ici."></textarea>
            </div>
            
            <h2>3. Consigne pour l'IA</h2>
            <label for="aiPrompt">Instructions d'analyse</label>
            <textarea id="aiPrompt" rows="8">Tu es un analyste tactique de la Gendarmerie. Ton rôle est de synthétiser les données de l'Ordre Initial (OI) et du Retour d'Expérience (RETEX) pour en tirer des leçons.

En t'appuyant uniquement sur les données structurées fournies ci-dessous:
1.  **Synthèse:** Résume l'écart entre le plan (OI) et l'exécution (RETEX).
2.  **Points Clés (Forces/Faiblesses):** Identifie 3 points forts et 3 points faibles clairs de l'opération.
3.  **Amélioration:** Propose une recommandation tactique concrète.

Formatte ta réponse en Markdown. Utilise des listes à puces et commence par "### Analyse Stratégica". S'il manque des données, indique RAS (Rien À Signaler).</textarea>
            
            <button type="button" id="launchAnalysisBtn" class="action-button" disabled>
                <span class="material-symbols-outlined" style="vertical-align: middle;">memory</span> Lancer l'Analyse (Localement)
            </button>
        </form>
        
        <h2>4. Rapport d'Analyse</h2>
        <div id="analysisOutput">
            Le rapport d'analyse de l'IA apparaîtra ici.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/marked.min.js"></script>
    <script>
        // --- Variables Globales ---
        let pipeline = null;
        let oiData = null;
        let retexData = [];
        // Utilisation d'un modèle de démonstration de transformers.js. 
        // L'utilisateur devra adapter ce nom au modèle ONNX/Transformer.js qu'il utilise.
        const modelName = 'Xenova/all-MiniLM-L6-v2'; 
        
        // --- Fonctions d'Utilité (Importées/Adaptées de praxis.html/js) ---
        
        // 1. Gestion du Thème et du Dock Menu
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            const darkModeIcon = document.getElementById('darkModeIcon');
            const dockMenu = document.getElementById('dockMenu');
            const dockToggleBtn = document.getElementById('dockToggleBtn');

            function toggleTheme() {
                body.classList.toggle('light-mode');
                const isLightMode = body.classList.contains('light-mode');
                const newTheme = isLightMode ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                darkModeIcon.textContent = isLightMode ? 'clear_day' : 'nightlight';
            }

            function initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                if (savedTheme === 'light') {
                    body.classList.add('light-mode');
                    body.classList.remove('dark-mode');
                    darkModeIcon.textContent = 'clear_day';
                } else {
                    body.classList.add('dark-mode');
                    body.classList.remove('light-mode');
                    darkModeIcon.textContent = 'nightlight';
                }
            }
            
            if (dockToggleBtn && dockMenu) {
                dockToggleBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    dockMenu.classList.toggle('collapsed');
                    localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed'));
                });
                if (localStorage.getItem('dockCollapsed') === 'true') {
                    dockMenu.classList.add('collapsed');
                }
            }


            if (darkModeToggle) darkModeToggle.addEventListener('click', toggleTheme);
            initTheme();
        });


        // 2. Chargement des données OI depuis localStorage
        function loadOiData() {
            const dataString = localStorage.getItem('oiFormData');
            const oiDataDisplay = document.getElementById('oiDataDisplay');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');
            
            if (!dataString) {
                oiDataDisplay.value = "Erreur: Aucune donnée 'oiFormData' trouvée dans la session locale (localStorage). Veuillez d'abord remplir le formulaire Praxis.";
                oiData = null;
                launchAnalysisBtn.disabled = true;
                return null;
            }
            try {
                const fullOiData = JSON.parse(dataString);
                
                // Extraction et formatage des données textuelles clés pour l'IA
                const relevantData = {
                    situation: {
                        generale: fullOiData.situation_generale,
                        particuliere: fullOiData.situation_particuliere,
                    },
                    adversaire: {
                        nom: fullOiData.nom_adversaire,
                        domicile: fullOiData.domicile_adversaire,
                        etat_esprit: fullOiData.etat_esprit_list ? fullOiData.etat_esprit_list.join(', ') : 'RAS',
                        volume: fullOiData.volume_list ? fullOiData.volume_list.join(', ') : 'RAS',
                        armes: fullOiData.armes_connues,
                        me: fullOiData.me_list ? fullOiData.me_list.join(', ') : 'RAS',
                    },
                    execution: {
                        date: fullOiData.date_execution,
                        heure: fullOiData.heure_execution,
                        type_action: fullOiData.type_action,
                        hypotheses: [fullOiData.hypothese_h1, fullOiData.hypothese_h2, fullOiData.hypothese_h3].filter(Boolean).join(' / '),
                        chronologie: fullOiData.time_events ? fullOiData.time_events.map(e => `${e.type} à ${e.hour}: ${e.description}`).join('; ') : 'RAS',
                    },
                    articulation_india: {
                        mission: fullOiData.india_mission,
                        cat: fullOiData.india_cat,
                    },
                    articulation_ao: {
                        mission: fullOiData.ao_mission,
                        cat: fullOiData.ao_cat,
                    },
                    patracdvr_composition: fullOiData.patracdvr_rows ? fullOiData.patracdvr_rows.flatMap(row => row.members).map(m => `${m.trigramme} (${m.cellule}, ${m.fonction})`).join('; ') : 'RAS',
                };

                const formattedText = JSON.stringify(relevantData, null, 2);
                oiDataDisplay.value = `Données OI chargées pour l'analyse: \n\n${formattedText}`;
                
                // Mettre à jour l'objet global
                oiData = relevantData; 
                
                // Activer le bouton si le modèle est prêt et les données RETEX sont là
                if (pipeline && retexData.length > 0) {
                    launchAnalysisBtn.disabled = false;
                }
                
                return relevantData;
            } catch (e) {
                oiDataDisplay.value = `Erreur de parsing des données OI : ${e.message}`;
                console.error(e);
                oiData = null;
                launchAnalysisBtn.disabled = true;
                return null;
            }
        }
        
        // 3. Gestion de l'importation des fichiers RETEX
        function handleRetexFilesChange(event) {
            const files = event.target.files;
            const retexFileNames = document.getElementById('retexFileNames');
            const retexDataDisplay = document.getElementById('retexDataDisplay');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');

            if (files.length === 0) {
                retexFileNames.textContent = 'Aucun fichier sélectionné';
                retexDataDisplay.value = '';
                retexData = [];
                launchAnalysisBtn.disabled = true;
                return;
            }
            
            retexFileNames.textContent = `${files.length} fichier(s) sélectionné(s). Lecture en cours...`;

            let allReports = [];
            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            allReports.push(jsonData);
                        } catch (error) {
                            console.error(`Erreur de lecture du fichier ${file.name}:`, error);
                        }
                        resolve();
                    };
                    reader.onerror = () => resolve();
                    reader.readAsText(file);
                });
            });

            Promise.all(promises).then(() => {
                retexData = allReports;
                retexFileNames.textContent = `${allReports.length} rapport(s) JSON valide(s) chargé(s).`;
                retexDataDisplay.value = `Données RETEX consolidées (${allReports.length} rapports): \n\n${JSON.stringify(allReports, null, 2)}`;
                
                // Vérifier si l'analyse peut être lancée (modèle chargé, OI et RETEX présents)
                if (pipeline && oiData && retexData.length > 0) {
                    launchAnalysisBtn.disabled = false;
                } else {
                     launchAnalysisBtn.disabled = true;
                }
            });
        }
        
        // 4. Initialisation du modèle LLM local
        async function initializeModel() {
            const modelStatus = document.getElementById('modelStatus');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');
            modelStatus.textContent = `Chargement du modèle d'IA local (${modelName}). Veuillez patienter...`;
            
            try {
                // Utilisation de la librairie transformers.js
                pipeline = await self.transformers.pipeline(
                    'text-generation', 
                    modelName,
                    { 
                        // Ajoutez ici des options de configuration spécifiques pour votre modèle ONNX
                        // Par exemple, pour forcer l'utilisation d'ONNX si plusieurs pipelines sont disponibles
                    }
                );
                
                modelStatus.textContent = `Modèle d'IA local (${pipeline.model.model_id}) est Prêt! ✅`;
                // Activer le bouton d'analyse si les données sont déjà chargées
                if (oiData && retexData.length > 0) {
                    launchAnalysisBtn.disabled = false;
                }
            } catch (e) {
                modelStatus.textContent = `Erreur de chargement du modèle d'IA : ${e.message}. Veuillez vérifier la disponibilité du modèle et vos configurations ONNX.`;
                launchAnalysisBtn.disabled = true;
                console.error("Erreur de chargement du pipeline d'IA locale:", e);
            }
        }
        
        // 5. Fonction principale d'analyse
        async function launchAnalysis() {
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');
            const analysisOutput = document.getElementById('analysisOutput');
            const aiPrompt = document.getElementById('aiPrompt').value;

            if (!pipeline) {
                analysisOutput.innerHTML = '<p>Le modèle d\'IA n\'est pas chargé ou est en erreur. Veuillez patienter ou vérifier le statut.</p>';
                return;
            }
            if (!oiData || retexData.length === 0) {
                analysisOutput.innerHTML = '<p>Veuillez charger les données de l\'OI et au moins un fichier RETEX JSON.</p>';
                return;
            }

            launchAnalysisBtn.disabled = true;
            launchAnalysisBtn.textContent = 'Analyse en cours... (Le temps d\'attente dépend de votre appareil)';
            analysisOutput.innerHTML = '<p style="text-align:center;">L\'analyse locale a débuté. Cela peut prendre plusieurs minutes sur les petits modèles ou appareils mobiles.</p>';

            // Concaténation des données pour le prompt
            const prompt = `
[CONSIGNE D'ANALYSE]
${aiPrompt}

[DONNÉES ORDRE INITIAL (OI)]
${JSON.stringify(oiData, null, 2)}

[DONNÉES RETOUR D'EXPÉRIENCE (RETEX) - ${retexData.length} RAPPORT(S)]
${JSON.stringify(retexData, null, 2)}

[RÉPONSE]
`;

            try {
                // Exécution du modèle local
                const output = await pipeline(prompt, {
                    max_new_tokens: 512,
                    do_sample: true,
                    temperature: 0.7,
                    repetition_penalty: 1.2,
                });

                let generatedText = output[0]?.generated_text || "Erreur : Texte généré non trouvé.";
                
                // Nettoyage de la réponse pour supprimer le prompt répété
                const responseMarker = "[RÉPONSE]";
                let startIndex = generatedText.indexOf(responseMarker);
                if (startIndex !== -1) {
                    generatedText = generatedText.substring(startIndex + responseMarker.length).trim();
                } else {
                    // Alternative si le marqueur n'est pas utilisé
                    const analysisTitle = "### Analyse Stratégica";
                    startIndex = generatedText.indexOf(analysisTitle);
                    if (startIndex !== -1) {
                        generatedText = generatedText.substring(startIndex).trim();
                    }
                }
                
                // Rendu Markdown (suppose marked.js est chargé via CDN)
                analysisOutput.innerHTML = window.marked.parse(generatedText);

            } catch (e) {
                analysisOutput.innerHTML = `<p style="color: var(--danger-red);">Erreur lors de l'exécution du modèle local. L'erreur peut être due à un manque de mémoire ou à une mauvaise configuration. Détails : ${e.message}</p>`;
                console.error("Erreur d'inférence LLM:", e);
            } finally {
                launchAnalysisBtn.disabled = false;
                launchAnalysisBtn.textContent = 'Lancer l\'Analyse (Localement)';
            }
        }
        
        // --- Événements et Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            const loadOiBtn = document.getElementById('loadOiBtn');
            const selectRetexFilesBtn = document.getElementById('selectRetexFilesBtn');
            const retexFileInput = document.getElementById('retexFileInput');
            const launchAnalysisBtn = document.getElementById('launchAnalysisBtn');

            // 1. Initialisation du Modèle (asynchrone)
            initializeModel();
            
            // 2. Gestion des Boutons
            if (loadOiBtn) loadOiBtn.addEventListener('click', loadOiData);
            if (selectRetexFilesBtn) selectRetexFilesBtn.addEventListener('click', () => retexFileInput.click());
            if (retexFileInput) retexFileInput.addEventListener('change', handleRetexFilesChange);
            
            // 3. Lancement de l'Analyse
            if (launchAnalysisBtn) launchAnalysisBtn.addEventListener('click', launchAnalysis);
            
            // Tentative de chargement initial de l'OI
            loadOiData();
        });
    </script>
</body>
</html>
