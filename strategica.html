<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praxis | Chatbot Phi-3.5 Local</title>
    <link rel="icon" href="https://oxsilaris06.github.io/Praxis/maskable_icon(2).png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-genai/dist/ort-genai.min.js"></script>

    <style>
        /* D√©finition des variables de couleurs pour le mode sombre/clair */
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
            --success-green: #27ae60;
        }

        /* Styles pour le mode Clair (s'il est activ√©) */
        body.light-mode {
            --bg-body: #f4f4f4; --bg-container: #ffffff; --bg-interactive: #ebebeb;
            --text-primary: #333333; --text-secondary: #666666; --border-color: #cccccc;
            --accent-blue: #1c729e; --accent-hover: #165b7b;
        }
        
        /* Styles de base */
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s; }
        header { background-color: var(--bg-container); padding: 10px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5em; color: var(--accent-blue); }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        /* Styles des boutons */
        button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; }
        button#loadModelBtn { background-color: var(--accent-blue); color: var(--text-primary); }
        button#loadModelBtn:hover:not(:disabled) { background-color: var(--accent-hover); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Styles de la zone de chat */
        #chat-container {
            max-width: 800px; margin: 20px auto; padding: 20px; 
            background-color: var(--bg-container); border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #messages-display { 
            height: 400px; overflow-y: scroll; padding: 15px; 
            border: 1px solid var(--border-color); margin-bottom: 15px; 
            background-color: var(--bg-interactive); border-radius: 4px;
        }
        #messages-display p { margin: 5px 0; padding: 5px; border-radius: 4px; line-height: 1.4; }
        
        /* Styles sp√©cifiques aux messages */
        .user-message { text-align: right; }
        .assistant-message { text-align: left; }
        
        /* Saisie de l'utilisateur */
        #userInput {
            flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); 
            border-radius: 4px 0 0 4px; background-color: var(--bg-body); 
            color: var(--text-primary); font-size: 1em;
        }
        #sendMessageBtn {
            padding: 10px 15px; background-color: var(--success-green); 
            color: var(--text-primary); border: none; border-radius: 0 4px 4px 0; 
            cursor: pointer; font-size: 1em;
        }
        #sendMessageBtn:hover:not(:disabled) { background-color: #219653; }
        
        /* Masquer les anciens √©l√©ments d'analyse */
        .analysis-section { display: none; }

    </style>
</head>
<body class="dark-mode">
    <header>
        <h1 style="font-family: 'Saira Stencil One', cursive;">Praxis - Chat Phi-3.5 Local</h1>
        <div>
            <button id="loadModelBtn">Charger le Mod√®le (Phi-3.5)</button>
            <button id="darkModeToggle">
                <span class="material-symbols-outlined" id="darkModeIcon">nightlight</span>
            </button>
        </div>
    </header>

    <div class="analysis-section">
        <input type="file" id="planInput" style="display: none;">
        <input type="file" id="retexInput" style="display: none;">
        <button id="analyzeBtn" disabled style="display: none;">Lancer l'Analyse</button>
        <button id="newAnalysisBtn" disabled style="display: none;">Nouvelle Analyse</button>
        <div id="results"></div>
    </div>
    
    <div id="chat-container">
        <div id="messages-display">
            <p style="color: var(--text-secondary);">
                **Syst√®me :** Bienvenue dans le Chatbot Phi-3.5 Local. 
                Veuillez cliquer sur "Charger le Mod√®le" ci-dessus pour commencer.
            </p>
        </div>

        <div style="display: flex;">
            <input type="text" id="userInput" placeholder="√âcrivez votre message ici..." disabled>
            <button id="sendMessageBtn" disabled>
                Envoyer
            </button>
        </div>
    </div>

    <script>
        // D√©claration des √©l√©ments DOM pour une meilleure manipulation
        const dom = {
            // Anciens s√©lecteurs (maintenus pour √©viter les erreurs, mais masqu√©s/non utilis√©s)
            planInput: document.getElementById('planInput'),
            retexInput: document.getElementById('retexInput'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            newAnalysisBtn: document.getElementById('newAnalysisBtn'),
            
            // Nouveaux s√©lecteurs pour le chat et le syst√®me
            loadModelBtn: document.getElementById('loadModelBtn'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            userInput: document.getElementById('userInput'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            messagesDisplay: document.getElementById('messages-display'),
        };

        let model = null; // Stocke l'objet mod√®le charg√© (onnxruntime-genai.LanguageModel)
        let messageHistory = []; // Stocke l'historique de la conversation pour le contexte

        /**
         * Ajoute un message √† la fen√™tre de chat.
         * @param {string} role - R√¥le du locuteur ('user', 'assistant', 'system').
         * @param {string} text - Le contenu du message.
         */
        function addMessage(role, text) {
            const messageElement = document.createElement('p');
            // Utilise un style en ligne pour la couleur, bas√© sur le r√¥le
            const roleColor = role === 'user' ? 'var(--accent-blue)' : 
                              role === 'assistant' ? 'var(--success-green)' : 'var(--text-secondary)';
            const roleLabel = role === 'user' ? '**Moi :**' : 
                              role === 'assistant' ? '**Phi-3.5 :**' : '**Syst√®me :**';
            
            messageElement.innerHTML = `<span style="font-weight: bold; color: ${roleColor};">${roleLabel}</span> ${text}`;
            messageElement.classList.add(`${role}-message`);
            
            dom.messagesDisplay.appendChild(messageElement);
            // Scroll vers le bas pour voir le nouveau message
            dom.messagesDisplay.scrollTop = dom.messagesDisplay.scrollHeight;
        }

        /**
         * Charge le mod√®le Phi-3.5-mini-instruct en utilisant onnxruntime-genai.
         * Les fichiers sont suppos√©s √™tre dans le m√™me r√©pertoire.
         */
        async function loadModel() {
            dom.loadModelBtn.disabled = true;
            dom.loadModelBtn.textContent = 'Chargement en cours...';
            addMessage('system', 'Tentative de chargement du mod√®le. Le temps de chargement d√©pend de la taille du mod√®le et de votre connexion.');

            try {
                // Utilisation de LanguageModel.forFiles qui g√®re le mod√®le et le tokenizer
                // Le nom 'model.onnx' est une supposition standard. Si votre fichier mod√®le a un autre nom, ajustez-le ici.
                // NOTE: Les fichiers doivent √™tre nomm√©s 'model.onnx', 'tokenizer.json', et 'genai_config.json' 
                // ou vous devez ajuster les chemins.
                model = await ort.genai.LanguageModel.forFiles({
                    model: 'model.onnx',
                    tokenizer: 'tokenizer.json', 
                    config: 'genai_config.json'
                });
                
                addMessage('system', `Mod√®le **Phi-3.5** charg√© avec succ√®s! üéâ Vous pouvez commencer √† discuter.`);
                dom.loadModelBtn.textContent = 'Mod√®le Charg√©';
                dom.sendMessageBtn.disabled = false; // Activation du bouton d'envoi
                dom.userInput.disabled = false;
                dom.userInput.focus();
                
            } catch (error) {
                console.error("Erreur lors du chargement du mod√®le:", error);
                addMessage('system', `Erreur lors du chargement du mod√®le. üò• D√©tails : ${error.message}. V√©rifiez la console pour plus d'informations et assurez-vous que tous les fichiers sont pr√©sents.`);
                dom.loadModelBtn.textContent = 'Erreur de Chargement';
                dom.loadModelBtn.disabled = false;
            }
        }

        /**
         * Construit le prompt de chat et g√©n√®re la r√©ponse du mod√®le.
         */
        async function sendMessage() {
            const userText = dom.userInput.value.trim();
            if (!userText || !model) {
                return;
            }

            // 1. Affichage du message utilisateur et nettoyage de l'entr√©e
            addMessage('user', userText);
            dom.userInput.value = '';
            dom.sendMessageBtn.disabled = true;
            dom.userInput.disabled = true;
            
            // 2. Mise √† jour de l'historique de la conversation
            messageHistory.push({ role: 'user', content: userText });

            // 3. Pr√©paration des prompts (format Chat Template Phi-3)
            let prompt = "";
            const systemPrompt = "Vous √™tes un assistant IA utile et amical. R√©pondez de mani√®re concise et pr√©cise.";
            
            // Ajout du prompt syst√®me (en d√©but de conversation, ou si l'historique est vide)
            prompt += `<|system|>\n${systemPrompt}<|end|>\n`;

            // Ajout de l'historique complet pour le contexte
            for (const msg of messageHistory) {
                if (msg.role === 'user') {
                    prompt += `<|user|>\n${msg.content}<|end|>\n`;
                } else if (msg.role === 'assistant') {
                    prompt += `<|assistant|>\n${msg.content}<|end|>\n`;
                }
            }
            // Indiquer au mod√®le qu'il doit r√©pondre
            prompt += `<|assistant|>\n`;
            
            addMessage('system', 'Phi-3.5 r√©fl√©chit... ü§î');

            try {
                // 4. Configuration et G√©n√©ration de la r√©ponse
                const options = {
                    maxLength: 2048, // Longueur maximale de la r√©ponse
                    doSample: true, 
                    temperature: 0.7, // √âchantillonnage pour la cr√©ativit√©
                    topP: 0.9,
                    // Si vous rencontrez des probl√®mes, essayez de d√©sactiver le doSample: false
                };
                
                const response = await model.generate(prompt, options);
                
                // 5. Extraction et affichage de la r√©ponse du mod√®le
                const fullResponse = response.text;
                
                // Extraction de la partie de la r√©ponse de l'assistant
                const assistantResponse = fullResponse
                    .substring(prompt.length) // Coupe la partie qui est l'historique que nous avons fourni
                    .trim()
                    .replace(/<\|end\|>\s*$/, ''); // Nettoie la balise de fin si elle est pr√©sente
                
                // 6. Mise √† jour de l'historique et affichage final
                // On retire le dernier message 'syst√®me' temporaire
                dom.messagesDisplay.lastChild.remove(); 
                
                addMessage('assistant', assistantResponse);
                messageHistory.push({ role: 'assistant', content: assistantResponse });
                
            } catch (error) {
                // On retire le dernier message 'syst√®me' temporaire
                dom.messagesDisplay.lastChild.remove(); 
                addMessage('assistant', `D√©sol√©, une erreur est survenue lors de la g√©n√©ration. ${error.message}`);
                console.error("Erreur de g√©n√©ration :", error);
            } finally {
                // R√©activation des commandes
                dom.sendMessageBtn.disabled = false;
                dom.userInput.disabled = false;
                dom.userInput.focus();
            }
        }


        // **********************************************
        // √âCOUTEURS D'√âV√âNEMENTS
        // **********************************************
        
        dom.loadModelBtn.addEventListener('click', loadModel);

        dom.sendMessageBtn.addEventListener('click', sendMessage);
        
        // Permet d'envoyer le message en appuyant sur 'Entr√©e'
        dom.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Gestion du mode sombre/clair (conserv√© de votre code original)
        dom.darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode'); 
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Initialisation du th√®me au chargement
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.replace('dark-mode', 'light-mode');
                document.getElementById('darkModeIcon').textContent = 'clear_day';
            }
            
            // La fonction analyzeDocuments et le reste du code de l'ancien outil 
            // n'est plus pertinent pour l'IA conversationnelle et est donc omis 
            // pour la simplicit√© et la focalisation sur l'objectif.
            
            // Si vous voulez conserver la fonction de gestion des fichiers (handleFileSelect), 
            // vous pouvez la r√©int√©grer ici.
        });
    </script>
</body>
</html>
